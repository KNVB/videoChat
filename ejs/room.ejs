<html>
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var messageBox;
			var socket = io.connect();
			
			$( document ).ready(function(){
				socket.emit("joinRoom",{roomId:"<%=roomId%>",userEmail:"<%=user.email%>"});
				document.getElementById("link").textContent=getShareLink();
				messageBox=document.getElementById("messageHistory");
			});
			function getShareLink(){
				var url = window.location.href;
				var arr = url.split("/");
				var result = arr[0] + "//" + arr[2]+"/joinRoom/<%=roomId%>";
				return result;
			}
			function leaveTheRoom(v){
				var req={roomId:"<%=roomId%>","userEmail":"<%=user.email%>"};
				socket.emit("userLeave",req);
			}
			function sendMessage(){
				var html="<div class=\"alert alert-success\" role=\"alert\">";
				html+="<%=user.alias%>";
				html+="<div class=\"d-flex justify-content-center\">"+document.getElementById("message").value+"</div>";
				html+="</div>";
				$(messageBox).append(html);
				var req={"roomId":"<%=roomId%>"};
				req["msg"]=document.getElementById("message").value;
				req["userAlias"]="<%=user.alias%>";
				socket.emit("sendMessage",req);
				document.getElementById("message").value="";
			}
			socket.on("receiveMsg",(res)=>{
				var html="<div class=\"alert alert-success\" role=\"alert\">";
				html+=res.alias;
				html+="<div class=\"d-flex justify-content-center\">"+res.msg+"</div>";
				html+="</div>";
				$(messageBox).append(html);
			});
			socket.on("userJoin",(res)=>{
				var html="<div class=\"alert alert-success\" role=\"alert\">";
					html+="User "+res.user.alias+" has joined the meeting";
					html+="</div>";
				$(messageBox).append(html);
				console.log("user count="+res.userCount);
			});
			socket.on("userLeave",(res)=>{
				var html="<div class=\"alert alert-danger\" role=\"alert\">";
					html+="User "+res.user.alias+" has left the meeting";
					html+="</div>";
				$(messageBox).append(html);
				console.log("user count="+res.userCount);
			});		
		</script>
	</head>
	<body>
		
		<div id="messageHistory" class="h-25 w-100 border border-primar overflow-auto">
		</div>
		<input type="text" id=message> <button onclick="sendMessage()">Send message</button>
		<form action="/leaveRoom/<%=roomId%>" method="post" onsubmit="leaveTheRoom(this)">
			<input type=hidden name=userEmail value="<%=user.email%>">
			<button>Leave the Room</button>
		</form>
		<div id="link">
		</div>
	</body>
</html>	